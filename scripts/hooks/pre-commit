#!/usr/bin/env zsh
set -euo pipefail

repo_root=$(git rev-parse --show-toplevel)

# Fast-exit if no staged additions/changes/renames
if git diff --cached --diff-filter=ACMR --quiet; then
  exit 0
fi

# Stash unstaged tracked changes only, keep index intact
did_stash=0
if ! git diff --quiet; then
  git stash -q --keep-index || true
  did_stash=1
fi

# Format only staged files
"$repo_root"/scripts/format --staged

# Re-add only files that changed relative to the index (from formatting)
git diff -z --name-only | xargs -0 -I {} git add -- {}

# Restore unstaged changes if we stashed
if [[ "$did_stash" -eq 1 ]]; then
  git stash pop -q || true
fi

exit 0
